<!DOCTYPE html>
{% extends "base.html" %}

{% block title %}
  Movie Recommendations Through Voice Recording
{% endblock %}


{% block content %}
  <a href="/logout">Logout</a>
  <a href="/movies_saved">Previously Recommended Movies</a>

  <h1>Movie Recommendations For You</h1>
  <p>Please click the button below and describe a movie you're interested in viewing.</p>

  <button id="recordButton">Start Recording</button>
  <button id="stopButton" style="display: none;">Stop Recording</button>

  <p id="statusText">Press the button to begin.</p>
  
  <button id="seeDetailsButton" style="display: none; margin-top: 10px;">See Movie Details</button>

  <script>
    const recordButton = document.getElementById('recordButton');
    const stopButton = document.getElementById('stopButton');
    const statusText = document.getElementById('statusText');

    let mediaRecorder;
    let chunks = [];

    const seeDetailsButton = document.getElementById('seeDetailsButton');
    let currentRecommendation = null;

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      recordButton.addEventListener('click', () => {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = e => {
              chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(chunks, { type: 'audio/wav' });
              const formData = new FormData();
              formData.append("audio", audioBlob);

              statusText.textContent = "Processing your voice...";
              recordButton.classList.remove("recording");
              stopButton.style.display = "none"; 
              seeDetailsButton.style.display = "none";

              // TODO: Store audio in MongoDB

              fetch("http://localhost:5002/recommend", {
                method: "POST",
                body: formData
              })
              .then(res => res.json())
              .then(data => {
                if (data.recommendation) {
                  currentRecommendation = data.recommendation;
                  statusText.textContent = "Movie suggestion: " + currentRecommendation;
                  seeDetailsButton.style.display = "inline-block";
                } else if (data.transcription) {
                  statusText.textContent = "Your transcription: " + data.transcription;
                } else {
                  statusText.textContent = "An error has occurred.";
                }
              })
              .catch(() => {
                statusText.textContent = "Please record again â€” an error has occurred.";
              });
            };

            mediaRecorder.start();
            statusText.textContent = "Recording...";

            recordButton.classList.add("recording");
            stopButton.style.display = "inline-block";

            setTimeout(() => {
              if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
              }
            }, 10000); // 10 seconds
          })
          .catch(err => {
            console.error("The following error occurred:", err);
            statusText.textContent = "Microphone access is required.";
          });
      });

      stopButton.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
      });
      
    } else {
      statusText.textContent = "getUserMedia is not supported in your browser.";
    }

    // Click handler for movie detail button
    seeDetailsButton.addEventListener('click', () => {
      if (currentRecommendation) {
        // TODO: link to movie by ID (from post to mongo db)
        window.location.href = `/movie/${encodeURIComponent(currentRecommendation)}`;
      }
    });
  </script>
  {% endblock %}
